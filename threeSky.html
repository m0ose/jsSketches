<html>
    <script src="https://cdn.jsdelivr.net/gh/lizard-isana/orb.js@2.3/build/orb.v2.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>
<body>
<script type=module>
    import * as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r99/three.module.js'
    window.THREE = THREE
    window.module ={}
    console.log(THREE)

    setTimeout(main, 1);
    async function main(){
        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 300000 );
        window.camera = camera
        var renderer = new THREE.WebGLRenderer();
        window.renderer=renderer
        window.scene = scene
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.body.appendChild( renderer.domElement );
        const stars = await loadStars()
        console.log('stars', stars)
        await addStars(scene, stars)
   
        console.log('fluffy')
        renderer.render( scene, camera );
        //const controls = await addTrackBall(camera, renderer.domElement, renderer, scene)
        //render(controls,scene,camera,renderer)
    }

    // function render(controls, scene, camera,renderer) {
    //     controls.update(); // only required if controls.enableDamping = true, or if controls.autoRotate = true
    //     renderer.render( scene, camera );
    //     requestAnimationFrame(render.bind(this,controls,scene, camera,renderer))
    //     console.log('.')
    // }

    async function addStars( scene, stars, lon=-106, lat=35, date=new Date()){
        var your_location = {
            "latitude":lat,
            "longitude":lon,
            "altitude":0
        }

        for(let i=0; i<stars.declination.length; i++){
            const ra = stars.rightAscension[i] * (180/Math.PI)
            const dec = stars.declination[i] * (180/Math.PI)
            const star = {
                "ra":ra,
                "dec":dec,
                "distance":54330
            }
            const observe_star = new Orb.Observation({
                "observer":your_location ,
                "target":star
            });
            const horizontal = observe_star.azel(date); 
            const mag = (8-stars.apparentMagnitude[i])*100
        
            const azimuth = horizontal.azimuth * (Math.PI/180)
            const elev = horizontal.elevation * (Math.PI/180)
            const celR = 110000
            const y = Math.sin(elev) * celR 
            const x = -Math.sin(azimuth) * Math.cos(elev) * celR 
            const z = -Math.cos(azimuth) * Math.cos(elev) *  celR
            let colorIndex = Math.floor(((stars.colorIndexBV[i] + 0.27)/3.9)*stars.color.length)
            colorIndex = Math.min(stars.color.length-1, colorIndex)
            const colour = stars.color[colorIndex]
            if(mag >800){
                console.log({x,y,z,mag})
            }
            // add geometry
            // if (mag>2){
                const geometry = new THREE.BoxGeometry(mag,mag,mag);
                const color = `rgb(${Math.floor(255*colour[0])},${Math.floor(255*colour[1])},${Math.floor(255*colour[2])})`
                const material = new THREE.MeshBasicMaterial( { color:color} );
                const cube = new THREE.Mesh( geometry, material );
                scene.add( cube );
                cube.position.x = x
                cube.position.y = y
                cube.position.z = z
            // }

            //  console.log({ra,dec, azimuth, elev,x,y,z})
        }

    }

    async function loadStars() {
        const resp = await fetch('./starData.json')
        const json = await resp.json()
        //console.log(json)
        return json
    }

    async function addTrackBall(camera, domElement, renderer,scene){
        try{
            var tb = await import('https://threejs.org/examples/jsm/controls/OrbitControls.js')
            var controls = new tb.OrbitControls( camera, renderer.domElement );

                controls.keys = [ 65, 83, 68 ];
                controls.addEventListener('end',(a,b)=>{
                    console.log('e',a,b)
                    controls.update();
                    renderer.render( scene, camera );

                })
                controls.enabled=true
                return controls
            console.log('trackball', controls)
        } catch(err){
            console.error(err)
        }
    }
</script>

</body>

</html>