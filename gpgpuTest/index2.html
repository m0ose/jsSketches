<html>


<script type='module'>
    import * as altAzUtils from './altAzUtils.js'
    import gpuJs from 'https://cdn.skypack.dev/gpu.js';
    import { reorganizedFragmentShader } from './reorganizedFragmentShader.js'
    const includedFunctions = ['deg2rad',
        'mag',
        'dot',
        'scale',
        'subVectors',
        'addVectors',
        'normalize',
        'threeD2AziAlt',
        'pointRotate3D',
        'aziAlt2ThreeD',
        'cantUp',
        'rotCantUp',
        'cantTan',
        'rotCantTan',
        'aziRot',
        'altRot',
        'cantAziAlt',
    ]
    // try it on CPU
    const pc = altAzUtils.cantAziAlt(0.2, 1, 1, 1, 1, 1, 0)
    logger('<b>correct val from cpu </b>', pc)

    // set up gpu.js
    const gpu = new gpuJs.GPU({ mode: 'gpu' })
    const funks = includedFunctions.map(x => altAzUtils[x])
    funks.forEach(f => gpu.addFunction(f))

    const kernel = gpu.createKernel(function () {
        const fu = cantAziAlt(0.2, 1, 1, 1, 1, 1, 0)
        return fu
    }).setOutput([1])

    // try and expect to fail
    try {
        const result1 = kernel();

        logger('gpu result. Wow it worked', result1)
    } catch (err) {
        // logger(`<pre>${kernel.compiledFragmentShader}</pre>`)
        logger('<b>Failed to run</b>',err)
    }

    // Try again after changing the order of the functions in the shader
    kernel.compiledFragmentShader = reorganizedFragmentShader
    const result2 = kernel();
    logger('<b>gpu result after changing the order of fragment shader</b>', result2)


    function logger(...args){
        let res = ''
        args.forEach(x=>res += `<div>${x}</div>`)
        document.body.innerHTML += `
            <div>${res}</div>
            <hr>
        `
        console.log(...args)
    }
</script>

</html>